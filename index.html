<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$CHDPU Lottery DApp</title>
    <!-- Using unpkg for better reliability for ethers.js -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js" type="application/javascript"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #2c3e50; }
        button { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        input[type="text"], input[type="number"] { padding: 8px; border-radius: 4px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .status { margin-top: 15px; padding: 10px; background-color: #e0f2f7; border-left: 5px solid #2196F3; }
        .error { background-color: #ffe0e0; border-left: 5px solid #f44336; }
        .player-list { list-style-type: none; padding: 0; }
        .player-list li { background-color: #f9f9f9; margin-bottom: 5px; padding: 8px; border-radius: 4px; border: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <h1>$CHDPU Community Lottery ðŸŽ²</h1>
        <p>Play with $CHDPU and win big!</p>

        <div class="status" id="statusMessage">Connect your wallet to get started.</div>

        <h2>Wallet Connection</h2>
        <button id="connectWalletBtn">Connect Rabby Wallet</button>
        <p>Connected Account: <span id="accountAddress">Not Connected</span></p>
        <p>Network ID: <span id="networkId"></span></p>

        <hr>

        <h2>Lottery Details</h2>
        <p>Lottery ID: <span id="lotteryId">N/A</span></p>
        <p>Ticket Price: <span id="ticketPrice">N/A</span> CHDPU</p>
        <p>Prize Pool: <span id="prizePool">N/A</span> CHDPU</p>
        <p>Current Players: <span id="numPlayers">N/A</span></p>
        <p>Winner of Last Round: <span id="currentWinner">N/A</span></p>
        <button id="refreshDetailsBtn">Refresh Details</button>

        <hr>

        <h2>Play Lottery</h2>
        <p>Cost per entry: <span id="entryCostSpan">Loading...</span> CHDPU</p>
        <p>Your CHDPU Balance: <span id="chdpuBalance">Loading...</span> CHDPU</p>
        <p>
            Before entering, you need to **Approve** the Lottery contract to spend your CHDPU.<br>
            Approval Amount (e.g., for multiple tickets): <input type="number" id="approvalAmount" placeholder="e.g., 500000 (CHDPU)" value="10000">
        </p>
        <button id="approveBtn">Approve CHDPU</button>
        <button id="enterLotteryBtn">Enter Lottery</button>

        <hr>

        <h2>Manager Actions (Owner Only)</h2>
        <button id="pickWinnerBtn">Pick Winner & Reset</button>
        <button id="withdrawFeesBtn" disabled>Withdraw Owner Fees (Not yet implemented in contract/UI)</button>

        <hr>

        <h2>Players in Current Round</h2>
        <ul id="playersList" class="player-list">
            <li>No players yet...</li>
        </ul>

    </div>

    <script>
        // --- CONFIGURATION ---
        // Your Deployed CHDPULottery Contract Address on Taraxa Mainnet
        const CHDPU_LOTTERY_CONTRACT_ADDRESS = "0x1a9e45671eb272af3341577fe166d20c52cd2750"; 

        // Your CHDPU Token Contract Address on Taraxa Mainnet
        const CHDPU_TOKEN_CONTRACT_ADDRESS = "0xaad94afea296dcf8c97d05dbf3733a245c3ea78f";
        const TARAXA_MAINNET_CHAIN_ID = 841; // Taraxa Mainnet Chain ID

        // --- ABI for CHDPULottery (Full ABI from the last corrected contract code) ---
        const CHDPU_LOTTERY_ABI = [
            {
                "inputs": [
                    { "internalType": "address", "name": "_chdpuTokenAddress", "type": "address" },
                    { "internalType": "uint256", "name": "_initialTicketPrice", "type": "uint256" },
                    { "internalType": "uint256", "name": "_ownerFeePercent", "type": "uint256" }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "uint256", "name": "_lotteryId", "type": "uint256" },
                    { "indexed": true, "internalType": "address", "name": "_player", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "_amount", "type": "uint256" }
                ],
                "name": "TicketPurchased",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "uint256", "name": "_newLotteryId", "type": "uint256" }
                ],
                "name": "LotteryReset",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" },
                    { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" }
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "uint256", "name": "_lotteryId", "type": "uint256" },
                    { "indexed": true, "internalType": "address", "name": "_winner", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "_prizeAmount", "type": "uint256" }
                ],
                "name": "WinnerPicked",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "chdpuToken",
                "outputs": [{ "internalType": "contract IERC20", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "currentWinner",
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "enter",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getContractCHDPUBalance",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getPlayers",
                "outputs": [{ "internalType": "address[]", "name": "", "type": "address[]" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "lotteryId",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "ownerFeePercentage",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "pickWinner",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "uint256", "name": "_newFeePercent", "type": "uint256" }
                ],
                "name": "setOwnerFeePercentage",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "uint256", "name": "_newPrice", "type": "uint256" }
                ],
                "name": "setTicketPrice",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "ticketPrice",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "address", "name": "newOwner", "type": "address" }
                ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // ABI for ERC20 (Standard functions for interacting with CHDPU token)
        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) returns (bool)",
            "function balanceOf(address account) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function allowance(address owner, address spender) view returns (uint256)" // Added allowance function
        ];

        let provider;
        let signer;
        let userAddress;
        let lotteryContract;
        let chdpuContract;
        let chdpuDecimals = 18; // Default, will try to fetch

        const statusMessage = document.getElementById('statusMessage');
        const accountAddress = document.getElementById('accountAddress');
        const networkId = document.getElementById('networkId');
        const lotteryIdSpan = document.getElementById('lotteryId');
        const ticketPriceSpan = document.getElementById('ticketPrice');
        const prizePoolSpan = document.getElementById('prizePool');
        const numPlayersSpan = document.getElementById('numPlayers');
        const currentWinnerSpan = document.getElementById('currentWinner');
        const chdpuBalanceSpan = document.getElementById('chdpuBalance');
        const entryCostSpan = document.getElementById('entryCostSpan');
        const playersList = document.getElementById('playersList');

        const approveBtn = document.getElementById('approveBtn');
        const enterLotteryBtn = document.getElementById('enterLotteryBtn');
        const pickWinnerBtn = document.getElementById('pickWinnerBtn');
        const refreshDetailsBtn = document.getElementById('refreshDetailsBtn');
        const approvalAmountInput = document.getElementById('approvalAmount');

        // --- Helper Functions ---
        function setStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'status error' : 'status';
        }

        async function updateUI() {
            if (!provider || !userAddress || !lotteryContract) {
                // If not fully connected, ensure buttons are disabled and return
                enterLotteryBtn.disabled = true;
                approveBtn.disabled = true;
                pickWinnerBtn.disabled = true;
                return;
            }

            try {
                // Get Lottery Details
                const currentLotteryId = await lotteryContract.lotteryId();
                const currentTicketPriceWei = await lotteryContract.ticketPrice();
                const currentPrizePoolWei = await lotteryContract.getContractCHDPUBalance(); 
                const players = await lotteryContract.getPlayers();
                const winnerAddress = await lotteryContract.currentWinner();

                lotteryIdSpan.textContent = currentLotteryId.toString();
                ticketPriceSpan.textContent = ethers.utils.formatUnits(currentTicketPriceWei, chdpuDecimals);
                prizePoolSpan.textContent = ethers.utils.formatUnits(currentPrizePoolWei, chdpuDecimals); 
                numPlayersSpan.textContent = players.length;
                currentWinnerSpan.textContent = winnerAddress === '0x0000000000000000000000000000000000000000' ? 'N/A (No winner yet or reset)' : winnerAddress;

                playersList.innerHTML = '';
                if (players.length > 0) {
                    players.forEach(player => {
                        const li = document.createElement('li');
                        li.textContent = player;
                        playersList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'No players yet. Be the first!';
                    playersList.appendChild(li);
                }

                // Get User CHDPU Balance and Allowance
                const balanceWei = await chdpuContract.balanceOf(userAddress);
                const allowanceWei = await chdpuContract.allowance(userAddress, CHDPU_LOTTERY_CONTRACT_ADDRESS);

                chdpuBalanceSpan.textContent = ethers.utils.formatUnits(balanceWei, chdpuDecimals);
                entryCostSpan.textContent = ethers.utils.formatUnits(currentTicketPriceWei, chdpuDecimals);

                // Enable/Disable Enter Lottery button based on balance and approval
                if (balanceWei.lt(currentTicketPriceWei)) {
                    enterLotteryBtn.disabled = true;
                    setStatus("Insufficient CHDPU balance to enter lottery. Please acquire more CHDPU.", true);
                } else if (allowanceWei.lt(currentTicketPriceWei)) {
                    enterLotteryBtn.disabled = true;
                    setStatus("Approve the lottery contract to spend your CHDPU. Click 'Approve CHDPU' above.", true);
                } else {
                    enterLotteryBtn.disabled = false;
                    setStatus("Wallet connected. Ready to play!");
                }
                
                // Always enable approve button if connected
                approveBtn.disabled = false;

                // Check if user is owner for pickWinnerBtn
                const contractOwner = await lotteryContract.owner();
                if (userAddress.toLowerCase() === contractOwner.toLowerCase()) {
                    pickWinnerBtn.disabled = false;
                } else {
                    pickWinnerBtn.disabled = true;
                }

            } catch (error) {
                setStatus(`Error updating UI: ${error.message}`, true);
                console.error("UI Update Error:", error);
                // Ensure buttons are disabled on error
                enterLotteryBtn.disabled = true;
                approveBtn.disabled = true;
                pickWinnerBtn.disabled = true;
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof window.ethereum === 'undefined') {
                setStatus("Rabby Wallet (or MetaMask) not detected. Please install it.", true);
                connectWalletBtn.disabled = true;
            } else {
                // Initial state: disable buttons until connected
                enterLotteryBtn.disabled = true;
                approveBtn.disabled = true;
                pickWinnerBtn.disabled = true;
            }
        });

        connectWalletBtn.addEventListener('click', async () => {
            try {
                if (!window.ethereum) {
                    throw new Error("Rabby Wallet not found. Please install it.");
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                accountAddress.textContent = userAddress;

                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                networkId.textContent = parseInt(chainId, 16);

                if (parseInt(chainId, 16) !== TARAXA_MAINNET_CHAIN_ID) {
                    setStatus(`Please switch your wallet to Taraxa Mainnet (Chain ID ${TARAXA_MAINNET_CHAIN_ID}).`, true);
                    // Disable buttons if on wrong network
                    enterLotteryBtn.disabled = true;
                    approveBtn.disabled = true;
                    pickWinnerBtn.disabled = true;
                    return; 
                }

                signer = provider.getSigner();

                // Initialize contract instances
                lotteryContract = new ethers.Contract(CHDPU_LOTTERY_CONTRACT_ADDRESS, CHDPU_LOTTERY_ABI, signer);
                chdpuContract = new ethers.Contract(CHDPU_TOKEN_CONTRACT_ADDRESS, ERC20_ABI, signer);

                // Try to get decimals from CHDPU token
                try {
                    chdpuDecimals = await chdpuContract.decimals();
                } catch (e) {
                    console.warn("Could not fetch CHDPU decimals, defaulting to 18.", e);
                }

                setStatus("Wallet connected and contracts loaded. Fetching lottery details...");
                updateUI();

                // Listen for account/network changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    userAddress = accounts[0];
                    accountAddress.textContent = userAddress || 'Not Connected';
                    setStatus(userAddress ? "Account changed. Updating UI..." : "Disconnected.", userAddress ? false : true);
                    updateUI();
                });
                window.ethereum.on('chainChanged', (chainId) => {
                    networkId.textContent = parseInt(chainId, 16);
                    setStatus(`Network changed to ${parseInt(chainId, 16)}. Please ensure it's Taraxa Mainnet.`, true);
                    window.location.reload(); // Reload for full re-initialization
                });

            } catch (error) {
                setStatus(`Wallet connection failed: ${error.message}`, true);
                console.error(error);
                // Ensure buttons are disabled on connection failure
                enterLotteryBtn.disabled = true;
                approveBtn.disabled = true;
                pickWinnerBtn.disabled = true;
            }
        });

        approveBtn.addEventListener('click', async () => {
            if (!signer || !chdpuContract) {
                setStatus("Please connect wallet first.", true);
                return;
            }
            try {
                // Parse the amount from the input field, assuming it's in full units (e.g., 500000)
                const amountToApprove = ethers.utils.parseUnits(approvalAmountInput.value, chdpuDecimals);
                setStatus("Approving CHDPU for lottery contract...");
                const tx = await chdpuContract.approve(CHDPU_LOTTERY_CONTRACT_ADDRESS, amountToApprove);
                setStatus(`Approval transaction sent: ${tx.hash}. Waiting for confirmation...`);
                await tx.wait(); // Wait for transaction to be mined
                
                // Add a small delay to ensure blockchain state propagates
                await new Promise(resolve => setTimeout(resolve, 2000)); // 2-second delay

                const updatedAllowanceWei = await chdpuContract.allowance(userAddress, CHDPU_LOTTERY_CONTRACT_ADDRESS);
                const updatedAllowanceFormatted = ethers.utils.formatUnits(updatedAllowanceWei, chdpuDecimals);
                console.log(`Allowance after approval: ${updatedAllowanceFormatted} CHDPU`);

                setStatus("CHDPU Approved successfully! Updating details...");
                updateUI(); // Re-check balance and allowance after approval
            } catch (error) {
                setStatus(`Approval failed: ${error.message}`, true);
                console.error("Approval error:", error);
            }
        });

        enterLotteryBtn.addEventListener('click', async () => {
            if (!signer || !lotteryContract) {
                setStatus("Please connect wallet first.", true);
                return;
            }
            // Add a final client-side check before sending transaction
            const currentTicketPriceWei = await lotteryContract.ticketPrice();
            const balanceWei = await chdpuContract.balanceOf(userAddress);
            const allowanceWei = await chdpuContract.allowance(userAddress, CHDPU_LOTTERY_CONTRACT_ADDRESS);

            if (balanceWei.lt(currentTicketPriceWei)) {
                setStatus("Cannot enter: Insufficient CHDPU balance.", true);
                return;
            }
            if (allowanceWei.lt(currentTicketPriceWei)) {
                setStatus("Cannot enter: Lottery contract not approved to spend enough CHDPU. Please approve first.", true);
                return;
            }

            try {
                setStatus("Entering lottery...");
                const tx = await lotteryContract.enter();
                await tx.wait();
                setStatus("Successfully entered the lottery!");
                updateUI();
            } catch (error) {
                setStatus(`Entering lottery failed: ${error.message}. Please ensure you have enough CHDPU and have approved the contract.`, true);
                console.error("Enter lottery error:", error);
            }
        });

        pickWinnerBtn.addEventListener('click', async () => {
            if (!signer || !lotteryContract) {
                setStatus("Please connect wallet first.", true);
                return;
            }
            // Basic check if current user is owner (can be bypassed by malicious users on frontend)
            // Contract's onlyOwner modifier handles actual security.
            const contractOwner = await lotteryContract.owner();
            if (userAddress.toLowerCase() !== contractOwner.toLowerCase()) {
                setStatus("Only the contract owner can pick a winner.", true);
                return;
            }

            try {
                setStatus("Picking winner and resetting lottery...");
                const tx = await lotteryContract.pickWinner();
                await tx.wait();
                setStatus("Winner picked, prize distributed, lottery reset!");
                updateUI();
            } catch (error) {
                setStatus(`Picking winner failed: ${error.message}`, true);
                console.error("Pick winner error:", error);
            }
        });

        refreshDetailsBtn.addEventListener('click', updateUI);

        // Initial UI update if wallet is already connected (e.g., after refresh)
        if (window.ethereum && window.ethereum.selectedAddress) {
            // Give a small delay to ensure ethers.js is fully loaded and DOM is ready
            setTimeout(() => {
                connectWalletBtn.click(); // Simulate click to connect
            }, 100);
        }

    </script>
</body>
</html>
